<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="generator" content="Hugo 0.55.1" />
	
	<link rel="icon" href="/">
	
	<title>Scala and Jupyter Notebook with Almond | Bayesian Statistics and Functional Programming </title>
	
	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
	 crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	<link href="/css/medium.css" rel="stylesheet">
	<link href="/css/additional.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container pr-0">
        
        <a class="navbar-brand" href="//">

            
            <img src="/" alt="logo">
            
        </a>
        

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">About</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/">Blog</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="https://github.com/jonnylaw">GitHub</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="https://twitter.com/lawsy">Twitter</a>
                </li>
                
            </ul>
        </div>
        
    </div>
</nav>


        <div class="site-content">   
            <div class="container">
<div class="mainheading">
    <h1 class="sitetitle">Bayesian Statistics and Functional Programming </h1>
    <p class="lead">
         Jonny Law
    </p>
</div><div class="main-content">
        
        <div class="container">
            <div class="row">
                
                <div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
    <p>Share</p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=Scala%20and%20Jupyter%20Notebook%20with%20Almond&url=%2f2019%2f04%2f15%2fscala-and-jupyter-notebook-with-almond%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=%2f2019%2f04%2f15%2fscala-and-jupyter-notebook-with-almond%2f" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://plus.google.com/share?url=%2f2019%2f04%2f15%2fscala-and-jupyter-notebook-with-almond%2f" onclick="window.open(this.href, 'google-share', 'width=550,height=435');return false;">
        <i class="fab fa-google"></i>
        </a>
        </li>

        <li class="ml-1 mr-1">
        <a target="_blank" href="https://www.xing.com/spi/shares/new?url=%2f2019%2f04%2f15%2fscala-and-jupyter-notebook-with-almond%2f" onclick="window.open(this.href, 'xing-share', 'width=550,height=435');return false;">
        <i class="fab fa-xing"></i>
        </a>
        </li>        
    </ul>

    
</div>
</div>
                                
                <div class="col-md-9 flex-first flex-md-unordered">
                    <div class="mainheading">
                        	
                                                
                        
                        <h1 class="posttitle">Scala and Jupyter Notebook with Almond</h1> 
                    </div>

                    
                    
                    
                    
                    
                    <div class="article-post">
                        


<p>Typically, when programming with Scala I use a combination of <a href="https://ensime.github.io/">ensime</a> in emacs, <a href="https://www.scala-sbt.org/">sbt</a> and the Scala repl. However, sometimes when working on a new project which requires a lot of data exploration and graphics it is sometimes more useful to have a notebook where figures are rendered inline with descriptions of why each figure has been generated and what it shows for future reference. Jupyter notebooks have long been the standard in Python (although I prefer rmarkdown and knitr when using R).</p>
<p>Jupyter notebooks can be initialised with many different kernels to serve a wide array of users. Recently there has been a release which combines the power of the <a href="https://ammonite.io/">Ammonite</a> scala repl which empowers users to write small Scala scripts where dependencies can be stored in the same script file and are fetched using coursier without the need for a large SBT project. Ammonite has many more features besides this, however scripting is one of my favourites. It also allows us to write self-contained Jupyter notebooks with dependencies by utilising Ammonite as the kernel of the Jupyter notebook using <a href="https://almond.sh/">Almond</a>.</p>
<p>In this blog, I will show you how to use Almond to fit a linear regression using the probabilistic programming language, <a href="https://github.com/stripe/rainier/">Rainier</a>.</p>
<div id="setup-of-almond" class="section level2">
<h2>Setup of Almond</h2>
<ol style="list-style-type: decimal">
<li>Install Jupyter Notebook</li>
<li>Install Almond <a href="https://almond.sh/docs/quick-start-install" class="uri">https://almond.sh/docs/quick-start-install</a></li>
<li>Run jupyter notebook and create a new document using the “Scala” kernel</li>
</ol>
</div>
<div id="scala-library-dependencies" class="section level2">
<h2>Scala library dependencies</h2>
<p>Ammonite lets you import dependencies directly from Maven central using a special import syntax, for example to import the latest version of the Rainier core library simply type:</p>
<pre class="scala"><code>import $ivy.`com.stripe::rainier:0.2.2`</code></pre>
<p>Them all imports from inside the Rainier library should be available. Additionally, we want to be able to use a plotting library <a href="https://github.com/cibotech/evilplot">Evilplot</a> which does not have a standard resolver. Luckily Ammonite makes adding new resolvers straightforward, simply add a new block which points to the Maven repository of cibotech. Note that this is not an especially common operation - since most OSS Scala libraries are stored in the <a href="https://search.maven.org/">Maven central repository</a>.</p>
<pre class="scala"><code>import coursier.MavenRepository

interp.repositories() ++= Seq(MavenRepository(
  &quot;http://dl.bintray.com/cibotech/public&quot;
))</code></pre>
<p>Then the plotting library can be imported, ensure this is in a new block.</p>
<pre class="scala"><code>import $ivy.`com.stripe::rainier-plot:0.2.2`</code></pre>
</div>
<div id="building-a-model-using-rainier" class="section level2">
<h2>Building a model using rainier</h2>
<p>The model under consideration is straightforward, a simple linear regression with unknown slope and intercept:</p>
<p><span class="math display">\[y_i = \alpha + \beta x_i + \varepsilon_i, \quad \varepsilon_i \sim \mathcal{N}(0, \sigma^2)\]</span></p>
<p>In order to perform inference to determine the posterior distribution of the unknown parameters, <span class="math inline">\(\psi = \{\alpha, \beta, \sigma\}\)</span> on this model using Rainier first we simulate some data from the model:</p>
<pre class="scala"><code>val (alpha, beta, sigma) =  (-1.5, 2.0, 0.5)

val lm = for {
  x &lt;- Normal(0, 1).param
  y &lt;- Normal(alpha + beta * x, sigma).param
} yield (x, y)

val sims = lm.sample(100)</code></pre>
<p>The code above uses rainiers sampling-based monad in order to simulate standard Normal data representing the covariates, <span class="math inline">\(x_i, i = 1,\dots,100\)</span> and the dependent variable <span class="math inline">\(y_i\)</span>. 100 <span class="math inline">\((x, y)\)</span> pairs are simulated from the model with the selected parameter values. Now it might be of interest to plot the data using the Evilplot plotting library. In order to view the plot inline within the Jupyter notebook the almond api is used, this is mostly taken from the <a href="https://github.com/stripe/rainier/commit/5c1b39c3d920dfc1df3433a1a71fda65c3883436">recent commit to Rainier</a> to support almond:</p>
<pre class="scala"><code>import com.cibo.evilplot.numeric.Point
import com.cibo.evilplot.plot._
import com.cibo.evilplot.plot.renderers.PointRenderer
import com.cibo.evilplot.plot.aesthetics.DefaultTheme._
import almond.interpreter.api._

def renderBytes(plot: com.cibo.evilplot.plot.Plot) = {
    val baos = new java.io.ByteArrayOutputStream
    javax.imageio.ImageIO
      .write(
        plot.render().asBufferedImage,
        &quot;png&quot;,
        baos)
    val array = baos.toByteArray
    baos.close
    array
}

DisplayData
  .png(renderBytes(ScatterPlot(
      sims.map { case (x, y) =&gt; Point(x, y) }
    ).xAxis()
     .yAxis()
     .frame()
     .rightLegend()))
 .show()</code></pre>
<p>The actual code used to build the scatter plot is within the function <code>renderBytes</code>, you should now see a plot which looks like:</p>
<div class="figure">
<embed src="/post/2019-04-15-scala-and-jupyter-notebook-with-almond_files/Screenshot%202019-04-15%20at%2015.55.29.png%20=500x500" />
<p class="caption">linear model</p>
</div>
<p>The code required to sample from the posterior distribution is similar to that required to simulate the model:</p>
<pre class="scala"><code>import com.stripe.rainier.compute._

def linearModel(data: Seq[(Double, Double)]): RandomVariable[Map[String, Real]] = for {
    alpha &lt;- Normal(0, 5).param
    beta &lt;- Normal(0, 5).param
    sigma &lt;- LogNormal(2, 2).param
    _ &lt;- Predictor[Double].from { x =&gt;
      Normal(alpha + beta * x, sigma)
    }
    .fit(data)
  } yield Map(&quot;alpha&quot; -&gt; alpha, &quot;beta&quot; -&gt; beta, &quot;sigma&quot; -&gt; sigma)</code></pre>
<p>First prior distributions are chosen for the static parameters, then the function <code>Predictor</code> is used to specify the likelihood for the linear regression as the Normal distribution. The data consists of a sequence of tuples. Finally to sample values from the posterior using Hamiltonian Monte Carlo:</p>
<pre class="scala"><code>val iters = linearModel(sims).sample(HMC(5), 5000, 100000, 100)</code></pre>
<div class="figure">
<embed src="/post/2019-04-15-scala-and-jupyter-notebook-with-almond_files/Screenshot%202019-04-15%20at%2016.09.10.png%20=500x500" />
<p class="caption">Posterior diagnostics</p>
</div>
<p>The full notebook can be viewed on Github <a href="https://github.com/jonnylaw/blog/blob/master/notebooks/rainier_linear_model.ipynb">here</a></p>
</div>

                    </div>
                    
                    
                    <div class="after-post-tags">
                        <ul class="tags">
                        
                        </ul>
                    </div>
                    
                    
                    
                    <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
                    
                    
                        <a class="d-block col-md-6 text-lg-right" href="/2019/02/22/national-cross-country/">National Cross Country &raquo;</a>
                    
                    <div class="clearfix"></div>
                    </div>
                    
                </div>
                
            </div>
        </div>
        
        
    </div>


            </div>
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
			<div class="d-md-flex align-items-center justify-content-center h-100">
				<h2 class="d-md-block d-none align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
			</div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
			
		</div>
	</div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net">Mediumish Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>

        </div>


<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/js/mediumish.js"></script>

    </body>
</html>
