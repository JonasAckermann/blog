<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>MCMC with Scala Breeze</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.20.2" />
        


        
            <meta name="author" content="Jonathan Law">
        
        
            
                <meta name="description" content="Bayesian Statistics and Functional Programming using Scala">
            
        

        

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:text:title" content="MCMC with Scala Breeze"/>
<meta name="twitter:title" content="MCMC with Scala Breeze"/>
<meta name="twitter:description" content="Bivariate Gaussian Model Scala Breeze is a numerical computing library, which also provides facilities for statistical computing. For instance, implementations of distributions and Markov Chain Monte Carlo for, typically used for Bayesian inference of intractable models. Today I am going to build a simple bivariate Gaussian model, simulate some realisations from the model and use the Breeze library to recover the mean of the bivariate Gaussian distribution and the variance."/>


        <meta property="og:title" content="MCMC with Scala Breeze" />
<meta property="og:description" content="Bivariate Gaussian Model Scala Breeze is a numerical computing library, which also provides facilities for statistical computing. For instance, implementations of distributions and Markov Chain Monte Carlo for, typically used for Bayesian inference of intractable models. Today I am going to build a simple bivariate Gaussian model, simulate some realisations from the model and use the Breeze library to recover the mean of the bivariate Gaussian distribution and the variance." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/breezemcmc/" />



<meta property="article:published_time" content="2017-04-23T14:13:12-05:00"/>
<meta property="article:modified_time" content="2017-04-23T14:13:12-05:00"/>











        
<meta itemprop="name" content="MCMC with Scala Breeze">
<meta itemprop="description" content="Bivariate Gaussian Model Scala Breeze is a numerical computing library, which also provides facilities for statistical computing. For instance, implementations of distributions and Markov Chain Monte Carlo for, typically used for Bayesian inference of intractable models. Today I am going to build a simple bivariate Gaussian model, simulate some realisations from the model and use the Breeze library to recover the mean of the bivariate Gaussian distribution and the variance.">


<meta itemprop="dateModified" content="2017-04-23T14:13:12-05:00" />
<meta itemprop="wordCount" content="615">



<meta itemprop="keywords" content="scala,scala, streaming, akka," />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="../../css/google-font.css" />
            <link rel="stylesheet" href="../../css/font-awesome.min.css" />
            <link rel="stylesheet" href="../../css/main.css" />
            <link rel="stylesheet" href="../../css/add-on.css" />
            <link rel="stylesheet" href="../../css/monokai-sublime.css">
        

        

        
        
        
            
        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="../../">Probabilistic Programming in Scala</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="../../blog">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="../../about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="../../blog">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="../../about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="../../post/breezemcmc/"><p>MCMC with Scala Breeze</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/akkaclient/"><p>An Akka HTTP Client with JSON Parsing</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/failureinfunctionalprogramming/"><p>Using Monads for Handling Failures and Exceptions</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/seasonaldlm/"><p>Seasonal DLM</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/kalmanfilter/"><p>The Kalman Filter in Scala</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            
        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="../../post/breezemcmc/">MCMC with Scala Breeze</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2017-04-23'>
            April 23, 2017</time>
        <span class="author">Jonathan Law</span>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            
        </ul>
    </section>
    

    <div id="content">
        <div id="bivariate-gaussian-model" class="section level1">
<h1>Bivariate Gaussian Model</h1>
<p><a href="https://github.com/scalanlp/breeze">Scala Breeze</a> is a numerical computing library, which also provides facilities for statistical computing. For instance, implementations of distributions and Markov Chain Monte Carlo for, typically used for Bayesian inference of intractable models. Today I am going to build a simple bivariate Gaussian model, simulate some realisations from the model and use the Breeze library to recover the mean of the bivariate Gaussian distribution and the variance.</p>
<p>The model is given by:</p>
<p><span class="math display">\[ \begin{pmatrix}X_1 \\ X_2\end{pmatrix} \sim \textrm{MVN}
  \begin{pmatrix}
    \begin{pmatrix}\mu_1 \\ \mu_2 \end{pmatrix}, 
    \begin{pmatrix} \sigma &amp; 0 \\ 0 &amp; \sigma \end{pmatrix} 
  \end{pmatrix} \]</span></p>
<p>The model has three parameters, the mean of each variable and the variance which is shared. <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> are independent and hence can be simulated from separate univariate Gaussian distributions:</p>
<pre class="scala"><code>import breeze.stats.distributions._
import breeze.linalg._

case class Parameters(mu: DenseVector[Double], sigma: Double)

def model(params: Parameters) = 
  MultivariateGaussian(params.mu, diag(DenseVector.fill(2)(params.sigma)))</code></pre>
<p>A simulation from the bivariate Gaussian model is plotted below, the mean for x is 2.0, the mean for y is 3.0 and the variance for each dimension is 0.5.</p>
<pre class="scala"><code>val p = Parameters(DenseVector(2.0, 3.0), 0.5)
val data = model(p).sample(100)</code></pre>
<p><img src="../../post/BreezeMcmc_files/figure-html/bivariate-normal-plot-1.png" width="672" /></p>
<p>It is simple to write a function to calculate the log-likelihood of this model:</p>
<pre class="scala"><code>def likelihood(points: Seq[DenseVector[Double]])(p: Parameters) =
    points.map { point =&gt; 
      MultivariateGaussian(p.mu, diag(DenseVector.fill(2)(p.sigma))).logPdf(point)
    }.reduce((x, y) =&gt; x + y)</code></pre>
<p>We take a sequence of observations, called <code>points</code>, since we know each point is simulated independently from the same distribution, then we simple <code>map</code> over the sequence of points the likelihood using the supplied value of the <code>Parameters</code>. The <code>reduce</code> operation then applies a pairwise function to each element of the list, in this case addition to get the value of the log-likelihood.</p>
<p>For a full Bayesian Inference, we must specify a prior distribution on the parameters, let’s choose a Multivariate Gaussian Distribution on the mean and a Gaussian distribution on the precision (the inverse of the variance). The Gamma distribution in Breeze is parameterised in terms of shape and scale, the mean of the Gamma distribution with shape 1/2 and scale 2 is <span class="math inline">\(1 = 1/\sigma\)</span>:</p>
<pre class="scala"><code>def prior(p: Parameters) = {
  MultivariateGaussian(DenseVector(2.0, 3.0), diag(DenseVector.fill(2)(3.0))).logPdf(p.mu) +
    Gamma(shape = 0.5, scale = 2.0).logPdf(1/p.sigma)
}</code></pre>
<p>The likelihood and the prior must be combined in order to determine the posterior:</p>
<p><span class="math display">\[ p(\theta | x) \propto p(x | \theta) p(\theta) \]</span></p>
<pre class="scala"><code>def logMeasure = (p: Parameters) =&gt; likelihood(data)(p) + prior(p)</code></pre>
<p>The MCMC method we will be using is the Metropolis-Hastings algorithm with a symmetric random walk proposal. First, we propose a new value of the parameters, <span class="math inline">\(\theta^*\)</span> from the parameter proposal distribution, then we accept them with probability <span class="math inline">\(\min(1, A)\)</span>, where <span class="math inline">\(A\)</span> is:</p>
<p><span class="math display">\[A = \frac{p(x|\theta^*)p(\theta^*)}{p(x|\theta)p(\theta)}\]</span></p>
<p>So if the likelihood multiplied by the prior is larger at the proposed value of the parameters than the previous value, we always accept, otherwise, we may reject. In this way, we can explore the parameter space. In a well tuned sampler, the algorithm will not accept every proposed value of the parameters, otherwise we are NOT exploring the whole of the parameter posterior, just areas of high posterior density. In this case we can increase the variance of the proposal distribution to get the acceptance rate down to approximately 30-40%. The proposal function is:</p>
<pre class="scala"><code>import breeze.numerics.exp

def propose(scale: Double)(p: Parameters) = 
  for {
    innov &lt;- MultivariateGaussian(DenseVector.fill(3)(0.0), diag(DenseVector.fill(3)(scale)))
    mu = p.mu + innov(0 to 1)
    sigma = p.sigma * exp(innov(2))
  } yield Parameters(mu, sigma)</code></pre>
<p>Here, the value of sigma is proposed on the log-scale, since sigma is expected to be positive. Now, we have all we need to build the sampler using breeze:</p>
<pre class="scala"><code>MarkovChain.metropolis(p, propose(0.05))(logMeasure)</code></pre>
<p><img src="../../post/BreezeMcmc_files/figure-html/bivariate-normal-parameters-1.png" width="672" /></p>
<p>The full code required to run the MCMC in Breeze can be found in this <a href="https://gist.github.com/jonnylaw/b75147d08ea89ec1b78fa94d5a4d2f7d">gist</a>. Note that Breeze is a required dependency.</p>
</div>

    </div>

    <footer>
        <ul class="stats">
    

    
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="../../post/akkaclient/"
                class="button big previous">An Akka HTTP Client with JSON Parsing</a></li>
    

    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'shortname';
    var disqus_identifier = '\/post\/breezemcmc\/';
    var disqus_title = 'MCMC with Scala Breeze';
    var disqus_url = '\/post\/breezemcmc\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <a href="../../" class="logo"><img src="../../img/main/logo.jpg" alt="Jonny Law&#39;s Blog" /></a>
                
            
            
                <header>
                    <h2>Probabilistic Programming in Scala</h2>
                    <p>Jonny Law</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/jonnylaw" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/lawjonny" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

































<li><a href="mailto:j.law1@ncl.ac.uk" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/breezemcmc/">MCMC with Scala Breeze</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-04-23'>
                                    April 23, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/akkaclient/">An Akka HTTP Client with JSON Parsing</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-02-21'>
                                    February 21, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/failureinfunctionalprogramming/">Using Monads for Handling Failures and Exceptions</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-01-04'>
                                    January 4, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/seasonaldlm/">Seasonal DLM</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-13'>
                                    December 13, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/kalmanfilter/">The Kalman Filter in Scala</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-12'>
                                    December 12, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /blog/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="../../categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="../../categories/scala/">scala</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="../../categories/scala-streaming-akka/">scala, streaming, akka</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/jonnylaw" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/lawjonny" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

































<li><a href="mailto:j.law1@ncl.ac.uk" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Probabilistic Programming in Scala. Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a>. Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="../../js/jquery.min.js"></script>
            <script src="../../js/skel.min.js"></script>
            <script src="../../js/util.js"></script>
            <script src="../../js/main.js"></script>
            <script src="../../js/backToTop.js"></script>
            <script src="../../js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

