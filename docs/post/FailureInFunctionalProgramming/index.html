<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Using Monads for Handling Failures and Exceptions</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.17" />
        


        
            <meta name="author" content="Jonny Law">
        
        
            
                <meta name="description" content="HTML5 UP theme, Future Imperfect with some extra goodies, ported by Julio Pescador. Powered by Hugo">
            
        

        

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:title" content="Using Monads for Handling Failures and Exceptions"/>
<meta name="twitter:description" content="In this post I will give a practical introduction to some useful structures for handling failure in functional programming.
Referential Transparency One of the most important properties of functional programming is referential transparency and programming with pure functions. This means we can substitute a pure function with its result, for intance if we have the function def f = 1 &#43; 2, we can replace every occurence of f with 3 and the final evaluation will remain unchanged"/>



        <meta property="og:title" content="Using Monads for Handling Failures and Exceptions" />
<meta property="og:description" content="In this post I will give a practical introduction to some useful structures for handling failure in functional programming.
Referential Transparency One of the most important properties of functional programming is referential transparency and programming with pure functions. This means we can substitute a pure function with its result, for intance if we have the function def f = 1 &#43; 2, we can replace every occurence of f with 3 and the final evaluation will remain unchanged" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/FailureInFunctionalProgramming/" />


<meta property="og:updated_time" content="2016-12-01T12:13:14-05:00"/>










        
<meta itemprop="name" content="Using Monads for Handling Failures and Exceptions">
<meta itemprop="description" content="In this post I will give a practical introduction to some useful structures for handling failure in functional programming.
Referential Transparency One of the most important properties of functional programming is referential transparency and programming with pure functions. This means we can substitute a pure function with its result, for intance if we have the function def f = 1 &#43; 2, we can replace every occurence of f with 3 and the final evaluation will remain unchanged">


<meta itemprop="dateModified" content="2016-12-01T12:13:14-05:00" />
<meta itemprop="wordCount" content="939">



<meta itemprop="keywords" content="scala," />

        

        

        
        
            
        

        
        

        
            
                
                    <link rel="stylesheet" href="../../css/main.min.css" />
                
            
        

        
        
        
            
        






    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="../../">Probabilistic Programming in Scala</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="../../blog">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="../../categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="../../about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="../../blog">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="../../categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="../../about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="../../post/SeasonalDlm/"><p>Seasonal DLM</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/KalmanFilter/"><p>The Kalman Filter in Scala</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/PracticalAkkaStreams/"><p>Practical Introduction to Akka Streaming</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/FailureInFunctionalProgramming/"><p>Using Monads for Handling Failures and Exceptions</p></a>
                    </li>
                
                    <li>
                        <a href="../../post/Temperature/"><p></p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            
        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="../../post/FailureInFunctionalProgramming/">Using Monads for Handling Failures and Exceptions</a></h1>
            
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-12-01'>
            December 1, 2016</time>
        <span class="author">Jonny Law</span>
        
            <p>5 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            
        </ul>
    </section>
    

    <div id="content">


<p>In this post I will give a practical introduction to some useful structures for handling failure in functional programming.</p>
<div id="referential-transparency" class="section level2">
<h2>Referential Transparency</h2>
<p>One of the most important properties of functional programming is referential transparency and programming with pure functions. This means we can substitute a pure function with its result, for intance if we have the function <code>def f = 1 + 2</code>, we can replace every occurence of <code>f</code> with <code>3</code> and the final evaluation will remain unchanged</p>
<p>This simple idea can lead to difficulties when considering functions which involve side effects, such as reading from external sources or generating random numbers. One example of a side effect is an exception, an imperative programmer might write a function to calculate a square root as:</p>
<pre class="scala"><code>def unsafe_sqrt(a: Double): Double = {
  if (a &gt; 0) math.sqrt(a)
  else throw new Exception(&quot;Can&#39;t calculate square root of negative number&quot;)
}</code></pre>
<p>This compiles fine, however if we wrote this function for an end user and they didnâ€™t look at the implementation they might not know the function can possibly return an exception.</p>
</div>
<div id="try" class="section level2">
<h2>Try</h2>
<p>In order to make it clear that a function can fail, we can return a <code>Try</code>:</p>
<pre class="scala"><code>def try_sqrt(a: Double): Try[Double] = {
  if (a &gt; 0) Success(math.sqrt(a))
  else Failure(throw new Exception(&quot;Can&#39;t calculate square root of negative number&quot;))
}</code></pre>
<p>Now, if someone were to use this function they would be forced to deal with the <code>Try</code> return type and understand that the function can return an exception. Try is actually an algebraic datatype (ADT), an illustrative implementation is:</p>
<pre class="scala"><code>sealed trait Try[+A]
case class Success[+A](a: A) extends Try[A]
case class Failure[+A](exception: Throwable) extends Try[A]</code></pre>
<p>This means that a <code>Try</code> can either be a <code>Success</code> or <code>Failure</code>. Learn more about <code>Try</code> in Daniel Westheideâ€™s excellent <a href="http://danielwestheide.com/blog/2012/12/26/the-neophytes-guide-to-scala-part-6-error-handling-with-try.html">Neophyteâ€™s Guide to Scala</a>.</p>
</div>
<div id="option" class="section level2">
<h2>Option</h2>
<p>Another simple structure to represent computations which may fail is <code>Option</code>, this is an algebraic datatype:</p>
<pre class="scala"><code>sealed trait Option[+A]
case class Some[+A](a: A) extends Option[A]
case class None extends Option[Nothing]</code></pre>
<p>In this case, option can either contain a value using the constructor <code>Some</code>, or can represent the absense of a value using <code>None</code>. This provides less information on failure that <code>Try</code>, but nevertheless is sometimes useful. We can re-write the <code>sqrt</code> function to return an optional value</p>
<pre class="scala"><code>def option_sqrt(a: Double): Option[Double] = {
  if (a &gt; 0) Some(math.sqrt(a))
  else None
}</code></pre>
<p>Now, when provide an incorrect argument to the function, we get <code>None</code> as the result.</p>
</div>
<div id="chaining-computations" class="section level1">
<h1>Chaining Computations</h1>
<p>In real world functional codebases we compose programs from many small functions. Letâ€™s consider the problem of how to apply <code>def sqrt(a: Double): Option[Double]</code> twice. A naive attempt would be to simply compose the functions as we would for the Scala math library:</p>
<pre class="scala"><code>def sqrt_twice = unsafe_sqrt _ compose unsafe_sqrt _</code></pre>
<p>The <code>_</code> represents partial application of <code>unsafe_sqrt</code>, if we try to compose the <code>option_sqrt</code> function as in this example we will get a type mismatch. One application of <code>option_sqrt</code> returns a typle <code>Option[Double]</code>, but we need the type <code>Double</code>. Luckily <code>Option</code> has a function defined on it for composing operations like this:</p>
<pre class="scala"><code>def flatMap[A, B](a: Option[A])(f: A =&gt; Option[B]): Option[B]</code></pre>
<p>We can now use <code>flatMap</code> to compose <code>option_sqrt</code>:</p>
<pre class="scala"><code>def sqrt_twice_option(x: Double): Option[Double] = 
  option_sqrt(x) flatMap option_sqrt</code></pre>
<p>Now we can calculate <code>sqrt_twice_option(81) = Some(3.0)</code>.</p>
<p>We can compose <code>try_sqrt</code> in the same way:</p>
<pre class="scala"><code>def sqrt_twice_try(x: Double): Try[Double] = 
  try_sqrt(81) flatMap try_sqrt</code></pre>
<p>Now, what if we want to compose <code>option_sqrt</code> and <code>try_sqrt</code>. This is not an easy problem in general, however the Scala standard library implements a <code>toOption</code> method on <code>Try</code> values. Hence we can just convert the output of <code>try_sqrt</code> to an <code>Option</code>, however we lose the text from the exception upon failure, which could illuminating in the event of a failure. Letâ€™s consider a more general way to compose the two.</p>
<div id="nested-maps" class="section level2">
<h2>Nested Maps</h2>
<p><code>Option</code> and <code>Try</code> are both monads (strictly <code>Try</code> is <a href="https://issues.scala-lang.org/browse/SI-6284">not a proper monad</a>), which means they are equipped with two methods which satisfy the monad laws. The two methods defined for all monads are:</p>
<pre class="scala"><code>trait Monad[A, M[_]] {
  def flatMap[B](f: A =&gt; M[B]): M[B]
  def pure(a: A): M[A]
}</code></pre>
<p>We can define all the functions on <code>Try</code> and <code>Option</code> using these two functions, for instance <code>map</code>:</p>
<pre class="scala"><code>def map[B](f: A =&gt; B): M[B] = this.flatMap(a =&gt; pure(f(a)))</code></pre>
<p>Now, we can use the <code>map</code> function to compose <code>option_sqrt</code> and <code>try_sqrt</code>:</p>
<pre class="scala"><code>def sqrt_twice(a: Double): Try[Option[Double]] = try_sqrt(a) map option_sqrt</code></pre>
<p>However, what if we want to apply another function to a value returned by this function:</p>
<pre class="scala"><code>def f(a: Double) = a + 1
sqrt_twice(81) map (_.map(f))
// Success(Some(4.0))</code></pre>
<p>We get the correct value, but we have to apply <code>map</code> twice, this seems cumbersome. There is a better way!</p>
</div>
<div id="monad-transformers" class="section level2">
<h2>Monad Transformers</h2>
<p>The functional programming library <a href="http://typelevel.org/cats/">cats</a>, short for category, has some built in types for dealing with nesting in a more elegent way. The type <code>OptionT[F[_], A]</code> can be used instead of <code>F[Option[A]]</code>, our <code>F[_]</code> type in this case is <code>Try[A]</code></p>
<pre class="scala"><code>import cats.implicits._
import cats.data.OptionT

def sqrt_twice_trans(a: Double): OptionT[Try, Double] = 
  OptionT.fromOption[Try](option_sqrt(a)) flatMap (b =&gt; OptionT.liftF(try_sqrt(b))</code></pre>
<p><code>OptionT</code> provides the function <code>fromOption</code> to transform the result of the <code>option_sqrt</code> function into the <code>OptionT</code> monad. The function <code>liftF</code> is used to lift any monad, in this case <code>Try</code> into the <code>OptionT</code> monad. This compiles and we if we now try to apply the function <code>def f(a: Double) = a + 1</code> to the result of this function we only need a single call to <code>map</code>. This is because <code>OptionT</code> is also a monad:</p>
<pre class="scala"><code>sqrt_twice_trans(81) map f
// OptionT(Success(Some(4.0)))</code></pre>
<p>This may seem like quite a lot of effort to remove a call to map, but removing unecessary duplication can help with readability of code, and enable bugs to be spotted earlier.</p>
</div>
</div>




    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="../../post/Temperature/"
                class="button big previous"></a></li>
    

    
        <li><a href="../../post/PracticalAkkaStreams/"
                class="button big next">Practical Introduction to Akka Streaming</a></li>
    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'shortname';
    var disqus_identifier = '\/post\/FailureInFunctionalProgramming\/';
    var disqus_title = 'Using Monads for Handling Failures and Exceptions';
    var disqus_url = '\/post\/FailureInFunctionalProgramming\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <a href="../../" class="logo"><img src="../../img/main/logo.jpg" alt="Jonny Law&#39;s Blog" /></a>
                
            
            
                <header>
                    <h2>Probabilistic Programming in Scala</h2>
                    <p>Jonny Law</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/jonnylaw" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/lawjonny" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

































<li><a href="mailto:j.law1@ncl.ac.uk" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/SeasonalDlm/">Seasonal DLM</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-13'>
                                    December 13, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/KalmanFilter/">The Kalman Filter in Scala</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-12'>
                                    December 12, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/PracticalAkkaStreams/">Practical Introduction to Akka Streaming</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-01'>
                                    December 1, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/FailureInFunctionalProgramming/">Using Monads for Handling Failures and Exceptions</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-01'>
                                    December 1, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="../../post/Temperature/"></a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '0001-01-01'>
                                    January 1, 0001</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /blog/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="../../categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="../../categories/scala/">scala</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/jonnylaw" target="_blank" title="GitHub" class="fa fa-github"></a></li>



















<li><a href="//instagram.com/lawjonny" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>

































<li><a href="mailto:j.law1@ncl.ac.uk" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Probabilistic Programming in Scala. Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a>. Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        

        
            
                
                    <script src="../../js/main.min.js"></script>
                
            
        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

